<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Golf Practice Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="ci-logo">
                    <div class="logo-circle">
                        <span class="logo-text">AG</span>
                    </div>
                    <span class="company-name">아바타골프</span>
                </div>
            </div>
            <div class="title-section">
                <h1 class="app-title">
                    <i class="fas fa-golf-ball-tee"></i>
                    골프 연습 기록 관리
                </h1>
            </div>
            <div class="version-section">
                <span class="version-badge">v1.0.0</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="navigation">
        <div class="nav-content">
            <button class="nav-item active" data-tab="practice">
                <i class="fas fa-golf-ball"></i>
                연습기록
            </button>
            <button class="nav-item" data-tab="records">
                <i class="fas fa-chart-line"></i>
                기록보기
            </button>
            <button class="nav-item" data-tab="analysis">
                <i class="fas fa-analytics"></i>
                분석
            </button>
            <button class="nav-item" data-tab="members">
                <i class="fas fa-users"></i>
                멤버관리
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Practice Recording Tab -->
        <section id="practice" class="tab-content active">
            <div class="container">
                <h2 class="section-title">골프 연습 기록</h2>
                
                <div class="practice-form">
                    <div class="form-group">
                        <label for="userSelect">연습자</label>
                        <select id="userSelect" class="form-control">
                            <option value="">연습자를 선택하세요</option>
                            <option value="오세민">오세민</option>
                            <option value="조재현">조재현</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="clubSelect">클럽</label>
                        <select id="clubSelect" class="form-control">
                            <option value="">클럽을 선택하세요</option>
                            <option value="드라이버">드라이버</option>
                            <option value="3번우드">3번우드</option>
                            <option value="5번우드">5번우드</option>
                            <option value="3번아이언">3번아이언</option>
                            <option value="4번아이언">4번아이언</option>
                            <option value="5번아이언">5번아이언</option>
                            <option value="6번아이언">6번아이언</option>
                            <option value="7번아이언">7번아이언</option>
                            <option value="8번아이언">8번아이언</option>
                            <option value="9번아이언">9번아이언</option>
                            <option value="피칭웨지">피칭웨지</option>
                            <option value="샌드웨지">샌드웨지</option>
                            <option value="퍼터">퍼터</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="distance">거리 (미터)</label>
                        <input type="number" id="distance" class="form-control" placeholder="예: 30" min="1" max="300">
                    </div>

                    <div class="form-group">
                        <label for="practiceType">연습 유형</label>
                        <select id="practiceType" class="form-control">
                            <option value="">연습 유형을 선택하세요</option>
                            <option value="accuracy">정확도 연습 (성공/실패)</option>
                            <option value="distance">거리 연습 (정확한 거리 측정)</option>
                        </select>
                    </div>

                    <!-- Accuracy Practice -->
                    <div id="accuracyPractice" class="practice-details" style="display: none;">
                        <div class="form-group">
                            <label for="totalAttempts">총 시도 횟수</label>
                            <input type="number" id="totalAttempts" class="form-control" placeholder="예: 10" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label for="successCount">성공 횟수</label>
                            <input type="number" id="successCount" class="form-control" placeholder="예: 6" min="0">
                        </div>
                    </div>

                    <!-- Distance Practice -->
                    <div id="distancePractice" class="practice-details" style="display: none;">
                        <div class="form-group">
                            <label for="attemptCount">시도 횟수</label>
                            <input type="number" id="attemptCount" class="form-control" placeholder="예: 10" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label for="distanceRecords">거리 기록 (쉼표로 구분)</label>
                            <textarea id="distanceRecords" class="form-control" placeholder="예: 4.95, 5.01, 4.98, 5.02, 4.99" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">메모</label>
                        <textarea id="notes" class="form-control" placeholder="연습 중 느낀 점이나 개선사항을 기록하세요" rows="3"></textarea>
                    </div>

                    <button id="savePractice" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        기록 저장
                    </button>
                </div>
            </div>
        </section>

        <!-- Records View Tab -->
        <section id="records" class="tab-content">
            <div class="container">
                <h2 class="section-title">연습 기록 보기</h2>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="filterUser">연습자</label>
                        <select id="filterUser" class="form-control">
                            <option value="">전체</option>
                            <option value="오세민">오세민</option>
                            <option value="조재현">조재현</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterClub">클럽</label>
                        <select id="filterClub" class="form-control">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterDate">날짜</label>
                        <input type="date" id="filterDate" class="form-control">
                    </div>
                </div>

                <div id="recordsList" class="records-list">
                    <!-- Records will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Analysis Tab -->
        <section id="analysis" class="tab-content">
            <div class="container">
                <h2 class="section-title">연습 분석</h2>
                
                <div class="analysis-cards">
                    <div class="analysis-card">
                        <h3>전체 통계</h3>
                        <div id="overallStats" class="stats-content">
                            <!-- Overall stats will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h3>클럽별 성과</h3>
                        <div id="clubStats" class="stats-content">
                            <!-- Club stats will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h3>진보 추이</h3>
                        <div id="progressChart" class="chart-container">
                            <!-- Progress chart will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Members Tab -->
        <section id="members" class="tab-content">
            <div class="container">
                <h2 class="section-title">멤버 관리</h2>
                
                <div class="members-list">
                    <div class="member-card">
                        <div class="member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="member-info">
                            <h3>오세민</h3>
                            <p>골프 연습생</p>
                            <div class="member-stats">
                                <span>총 연습: <strong id="oseminTotal">0</strong>회</span>
                                <span>성공률: <strong id="oseminSuccess">0</strong>%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="member-card">
                        <div class="member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="member-info">
                            <h3>조재현</h3>
                            <p>골프 연습생</p>
                            <div class="member-stats">
                                <span>총 연습: <strong id="jaehyunTotal">0</strong>회</span>
                                <span>성공률: <strong id="jaehyunSuccess">0</strong>%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-golf-ball-tee fa-spin"></i>
            <p>데이터를 처리중입니다...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 설정 (실제 프로젝트 설정으로 교체 필요)
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역 변수
        let practiceRecords = [];

        // DOM 요소들
        const practiceTypeSelect = document.getElementById('practiceType');
        const accuracyPractice = document.getElementById('accuracyPractice');
        const distancePractice = document.getElementById('distancePractice');
        const saveButton = document.getElementById('savePractice');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        // 연습 유형에 따른 폼 표시/숨김
        practiceTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            accuracyPractice.style.display = selectedType === 'accuracy' ? 'block' : 'none';
            distancePractice.style.display = selectedType === 'distance' ? 'block' : 'none';
        });

        // 네비게이션 탭 전환
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                // 모든 탭 비활성화
                navItems.forEach(nav => nav.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // 선택된 탭 활성화
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                // 탭별 데이터 로드
                if (targetTab === 'records') {
                    loadRecords();
                } else if (targetTab === 'analysis') {
                    loadAnalysis();
                } else if (targetTab === 'members') {
                    loadMemberStats();
                }
            });
        });

        // 연습 기록 저장
        saveButton.addEventListener('click', async function() {
            const user = document.getElementById('userSelect').value;
            const club = document.getElementById('clubSelect').value;
            const distance = document.getElementById('distance').value;
            const practiceType = document.getElementById('practiceType').value;
            const notes = document.getElementById('notes').value;

            // 유효성 검사
            if (!user || !club || !distance || !practiceType) {
                showToast('모든 필수 항목을 입력해주세요.', 'error');
                return;
            }

            showLoading(true);

            try {
                const practiceData = {
                    user: user,
                    club: club,
                    distance: parseInt(distance),
                    practiceType: practiceType,
                    notes: notes,
                    timestamp: new Date(),
                    date: new Date().toISOString().split('T')[0]
                };

                if (practiceType === 'accuracy') {
                    const totalAttempts = document.getElementById('totalAttempts').value;
                    const successCount = document.getElementById('successCount').value;
                    
                    if (!totalAttempts || !successCount) {
                        showToast('정확도 연습의 시도 횟수와 성공 횟수를 입력해주세요.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    practiceData.totalAttempts = parseInt(totalAttempts);
                    practiceData.successCount = parseInt(successCount);
                    practiceData.successRate = (parseInt(successCount) / parseInt(totalAttempts) * 100).toFixed(1);
                } else if (practiceType === 'distance') {
                    const attemptCount = document.getElementById('attemptCount').value;
                    const distanceRecords = document.getElementById('distanceRecords').value;
                    
                    if (!attemptCount || !distanceRecords) {
                        showToast('거리 연습의 시도 횟수와 거리 기록을 입력해주세요.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    const distances = distanceRecords.split(',').map(d => parseFloat(d.trim())).filter(d => !isNaN(d));
                    
                    if (distances.length === 0) {
                        showToast('올바른 거리 기록을 입력해주세요.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    practiceData.attemptCount = parseInt(attemptCount);
                    practiceData.distances = distances;
                    practiceData.averageDistance = (distances.reduce((a, b) => a + b, 0) / distances.length).toFixed(2);
                    practiceData.minDistance = Math.min(...distances).toFixed(2);
                    practiceData.maxDistance = Math.max(...distances).toFixed(2);
                }

                // Firebase에 저장
                await addDoc(collection(db, 'practiceRecords'), practiceData);
                
                showToast('연습 기록이 성공적으로 저장되었습니다!', 'success');
                clearForm();
                
            } catch (error) {
                console.error('Error saving practice record:', error);
                showToast('기록 저장 중 오류가 발생했습니다.', 'error');
            } finally {
                showLoading(false);
            }
        });

        // 폼 초기화
        function clearForm() {
            document.getElementById('userSelect').value = '';
            document.getElementById('clubSelect').value = '';
            document.getElementById('distance').value = '';
            document.getElementById('practiceType').value = '';
            document.getElementById('totalAttempts').value = '';
            document.getElementById('successCount').value = '';
            document.getElementById('attemptCount').value = '';
            document.getElementById('distanceRecords').value = '';
            document.getElementById('notes').value = '';
            
            accuracyPractice.style.display = 'none';
            distancePractice.style.display = 'none';
        }

        // 기록 로드
        async function loadRecords() {
            showLoading(true);
            
            try {
                const q = query(collection(db, 'practiceRecords'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                practiceRecords = [];
                querySnapshot.forEach((doc) => {
                    practiceRecords.push({ id: doc.id, ...doc.data() });
                });
                
                displayRecords();
                
            } catch (error) {
                console.error('Error loading records:', error);
                showToast('기록을 불러오는 중 오류가 발생했습니다.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 기록 표시
        function displayRecords() {
            const recordsList = document.getElementById('recordsList');
            
            if (practiceRecords.length === 0) {
                recordsList.innerHTML = '<div class="no-records">아직 기록된 연습이 없습니다.</div>';
                return;
            }
            
            recordsList.innerHTML = practiceRecords.map(record => {
                const date = new Date(record.timestamp.seconds * 1000).toLocaleDateString('ko-KR');
                const time = new Date(record.timestamp.seconds * 1000).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let recordDetails = '';
                if (record.practiceType === 'accuracy') {
                    recordDetails = `
                        <div class="record-detail">
                            <span class="detail-label">시도:</span>
                            <span class="detail-value">${record.totalAttempts}회</span>
                        </div>
                        <div class="record-detail">
                            <span class="detail-label">성공:</span>
                            <span class="detail-value">${record.successCount}회</span>
                        </div>
                        <div class="record-detail">
                            <span class="detail-label">성공률:</span>
                            <span class="detail-value success-rate">${record.successRate}%</span>
                        </div>
                    `;
                } else if (record.practiceType === 'distance') {
                    recordDetails = `
                        <div class="record-detail">
                            <span class="detail-label">시도:</span>
                            <span class="detail-value">${record.attemptCount}회</span>
                        </div>
                        <div class="record-detail">
                            <span class="detail-label">평균거리:</span>
                            <span class="detail-value">${record.averageDistance}m</span>
                        </div>
                        <div class="record-detail">
                            <span class="detail-label">범위:</span>
                            <span class="detail-value">${record.minDistance}m ~ ${record.maxDistance}m</span>
                        </div>
                    `;
                }
                
                return `
                    <div class="record-card">
                        <div class="record-header">
                            <div class="record-user">${record.user}</div>
                            <div class="record-date">${date} ${time}</div>
                        </div>
                        <div class="record-content">
                            <div class="record-club">${record.club}</div>
                            <div class="record-distance">${record.distance}m</div>
                            ${recordDetails}
                            ${record.notes ? `<div class="record-notes">${record.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 분석 데이터 로드
        async function loadAnalysis() {
            showLoading(true);
            
            try {
                const querySnapshot = await getDocs(collection(db, 'practiceRecords'));
                const allRecords = [];
                querySnapshot.forEach((doc) => {
                    allRecords.push(doc.data());
                });
                
                displayAnalysis(allRecords);
                
            } catch (error) {
                console.error('Error loading analysis:', error);
                showToast('분석 데이터를 불러오는 중 오류가 발생했습니다.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 분석 표시
        function displayAnalysis(records) {
            // 전체 통계
            const totalRecords = records.length;
            const totalAttempts = records.reduce((sum, record) => {
                return sum + (record.totalAttempts || record.attemptCount || 0);
            }, 0);
            
            const accuracyRecords = records.filter(r => r.practiceType === 'accuracy');
            const totalSuccess = accuracyRecords.reduce((sum, record) => sum + (record.successCount || 0), 0);
            const totalAccuracyAttempts = accuracyRecords.reduce((sum, record) => sum + (record.totalAttempts || 0), 0);
            const overallSuccessRate = totalAccuracyAttempts > 0 ? (totalSuccess / totalAccuracyAttempts * 100).toFixed(1) : 0;
            
            document.getElementById('overallStats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${totalRecords}</div>
                    <div class="stat-label">총 연습 세션</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${totalAttempts}</div>
                    <div class="stat-label">총 시도 횟수</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${overallSuccessRate}%</div>
                    <div class="stat-label">전체 성공률</div>
                </div>
            `;
            
            // 클럽별 통계
            const clubStats = {};
            records.forEach(record => {
                if (!clubStats[record.club]) {
                    clubStats[record.club] = {
                        totalRecords: 0,
                        totalAttempts: 0,
                        totalSuccess: 0,
                        totalAccuracyAttempts: 0
                    };
                }
                
                clubStats[record.club].totalRecords++;
                clubStats[record.club].totalAttempts += (record.totalAttempts || record.attemptCount || 0);
                
                if (record.practiceType === 'accuracy') {
                    clubStats[record.club].totalSuccess += (record.successCount || 0);
                    clubStats[record.club].totalAccuracyAttempts += (record.totalAttempts || 0);
                }
            });
            
            const clubStatsHTML = Object.entries(clubStats).map(([club, stats]) => {
                const successRate = stats.totalAccuracyAttempts > 0 ? 
                    (stats.totalSuccess / stats.totalAccuracyAttempts * 100).toFixed(1) : 0;
                
                return `
                    <div class="club-stat">
                        <div class="club-name">${club}</div>
                        <div class="club-details">
                            <span>${stats.totalRecords}회 연습</span>
                            <span>성공률: ${successRate}%</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('clubStats').innerHTML = clubStatsHTML || '<div class="no-data">아직 데이터가 없습니다.</div>';
        }

        // 멤버 통계 로드
        async function loadMemberStats() {
            try {
                const querySnapshot = await getDocs(collection(db, 'practiceRecords'));
                const allRecords = [];
                querySnapshot.forEach((doc) => {
                    allRecords.push(doc.data());
                });
                
                // 오세민 통계
                const oseminRecords = allRecords.filter(r => r.user === '오세민');
                const oseminTotal = oseminRecords.length;
                const oseminAccuracyRecords = oseminRecords.filter(r => r.practiceType === 'accuracy');
                const oseminTotalAttempts = oseminAccuracyRecords.reduce((sum, r) => sum + (r.totalAttempts || 0), 0);
                const oseminTotalSuccess = oseminAccuracyRecords.reduce((sum, r) => sum + (r.successCount || 0), 0);
                const oseminSuccessRate = oseminTotalAttempts > 0 ? (oseminTotalSuccess / oseminTotalAttempts * 100).toFixed(1) : 0;
                
                // 조재현 통계
                const jaehyunRecords = allRecords.filter(r => r.user === '조재현');
                const jaehyunTotal = jaehyunRecords.length;
                const jaehyunAccuracyRecords = jaehyunRecords.filter(r => r.practiceType === 'accuracy');
                const jaehyunTotalAttempts = jaehyunAccuracyRecords.reduce((sum, r) => sum + (r.totalAttempts || 0), 0);
                const jaehyunTotalSuccess = jaehyunAccuracyRecords.reduce((sum, r) => sum + (r.successCount || 0), 0);
                const jaehyunSuccessRate = jaehyunTotalAttempts > 0 ? (jaehyunTotalSuccess / jaehyunTotalAttempts * 100).toFixed(1) : 0;
                
                document.getElementById('oseminTotal').textContent = oseminTotal;
                document.getElementById('oseminSuccess').textContent = oseminSuccessRate;
                document.getElementById('jaehyunTotal').textContent = jaehyunTotal;
                document.getElementById('jaehyunSuccess').textContent = jaehyunSuccessRate;
                
            } catch (error) {
                console.error('Error loading member stats:', error);
            }
        }

        // 로딩 표시
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // 토스트 알림
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 클럽 필터 옵션 동적 생성
            const clubSelect = document.getElementById('clubSelect');
            const filterClub = document.getElementById('filterClub');
            const clubs = ['드라이버', '3번우드', '5번우드', '3번아이언', '4번아이언', '5번아이언', '6번아이언', '7번아이언', '8번아이언', '9번아이언', '피칭웨지', '샌드웨지', '퍼터'];
            
            clubs.forEach(club => {
                const option1 = new Option(club, club);
                const option2 = new Option(club, club);
                clubSelect.appendChild(option1);
                filterClub.appendChild(option2);
            });
        });
    </script>
</body>
</html>
